<!DOCTYPE html>



 <html class="no-js"> 
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="author" content="Jerod Santo">
    <meta property="og:site_name" content="Jerod Santo">
    
    <meta name="description" content="Whenever is an awesome library that:

&ldquo;provides a clean ruby syntax for defining messy cron jobs and running them Whenever.

Whenever has become very popular for use with Rails apps and there are plenty of tutorials on how to use it. This RailsCast is a good place to get started if you&rsquo;re interested in that.
However, I haven&rsquo;t seen too many people writing about using the library outside of Rails (or other web frameworks).">
    <meta property="st:title" content="Self-Scheduling Ruby Scripts">
    <meta property="og:title" content="Self-Scheduling Ruby Scripts">
    <meta property="og:description" content="Whenever is an awesome library that:

&ldquo;provides a clean ruby syntax for defining messy cron jobs and running them Whenever.

Whenever has become very popular for use with Rails apps and there are plenty of tutorials on how to use it. This RailsCast is a good place to get started if you&rsquo;re interested in that.
However, I haven&rsquo;t seen too many people writing about using the library outside of Rails (or other web frameworks).">
    <meta property="og:type" content="article">
    
    <meta property="og:image" content="/icon.png">
    
    
    <title>
      Self-Scheduling Ruby Scripts | Jerod Santo
    </title>

    <link rel="icon" href="/icon.png" sizes="256x256" type="image/png">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" type="text/css" media="all" href="/styles.css">
    <script>
       
      window.grunticon=function(e){if(e&&3===e.length){var t=window,n=!(!t.document.createElementNS||!t.document.createElementNS("http://www.w3.org/2000/svg","svg").createSVGRect||!document.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#Image","1.1")||window.opera&&-1===navigator.userAgent.indexOf("Chrome")),o=function(o){var r=t.document.createElement("link"),a=t.document.getElementsByTagName("script")[0];r.rel="stylesheet",r.href=e[o&&n?0:o?1:2],a.parentNode.insertBefore(r,a)},r=new t.Image;r.onerror=function(){o(!1)},r.onload=function(){o(1===r.width&&1===r.height)},r.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=="}};
      grunticon(["/icons/icons.data.svg.css", "/icons/icons.data.png.css", "/icons/icons.fallback.css"]);
    </script>

    <link href='//fonts.googleapis.com/css?family=Roboto+Condensed:400italic,400' rel='stylesheet' type='text/css'>
    <script src="//use.typekit.net/ozg5mvx.js"></script>
    <script>try{Typekit.load();}catch(e){}</script>
    <script src="/js/modernizr-custom.js"></script>

    

    <link rel="alternate" type="application/atom+xml" href="/index.xml" />
  </head>
  <body class="">
    
    <div class="main-header">
      <h1>
        <a href="/" title="Home">
          <span class="big-dot">&middot;</span> Jerod Santo <span class="big-dot">&middot;</span>
        </a>
      </h1>
      <a href="javascript:void(0);" title="Moar" class="main-header-more">+</a>
      <a href="/archives/" title="View Blog Archives" class="main-header-archive">Archives</a>
      <a href="mailto:jerod.santo@gmail.com" title="Contact Jerod" class="main-header-contact">Contact</a>
      <a href="/search/" title="Search the site" class="main-header-search">Search</a>
    </div>
    

    
<article class="post">
  <header class="post-header">
    <h1>Self-Scheduling Ruby Scripts</h1>
    
    <p class="post-date">
      August 20, 2009
    </p>
  </header>

  

  <div class="post-content">
    <p><a href="%22http://github.com/javan/whenever/%22">Whenever</a> is an awesome library that:</p>
<blockquote>
<p>&ldquo;provides a clean ruby syntax for defining messy cron jobs and running them Whenever.</p>
</blockquote>
<p><code>Whenever</code> has become very popular for use with Rails apps and there are plenty of tutorials on how to use it. This <a href="%22http://railscasts.com/episodes/164-cron-in-ruby%22">RailsCast</a> is a good place to get started if you&rsquo;re interested in that.</p>
<p>However, I haven&rsquo;t seen too many people writing about using the library outside of Rails (or other web frameworks).</p>
<p>I have a lot of Ruby scripts running on different servers all scheduled via cron and it&rsquo;s quite easy to forget what script is scheduled when and how often. I decided to try using <code>Whenever</code> to create the cron jobs instead of creating them manually. First, I set out to just slap arbitrary Ruby code inside of an <code>every</code> block. You know, something like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>every <span style="color:#032f62">:hour</span> <span style="color:#cf222e">do</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6639ba">puts</span> <span style="color:#0a3069">&#34;this is just some ruby that will execute every hour&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">end</span>
</span></span></code></pre></div><p>Unfortunately, it doesn&rsquo;t work like that. If it did, that would own because then we could simply wrap all our scripts inside an <code>every</code> block and call it a day. Instead the library lets you define a few different kinds of tasks inside an <code>every</code> block.</p>
<ol>
<li>rake tasks</li>
<li>external commands</li>
<li>runner scripts (Rails)</li>
</ol>
<p>So, we can use the <code>command</code> method to execute our pre-existing scripts like so:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>every <span style="color:#0550ae">1</span><span style="color:#0550ae">.</span>day<span style="color:#1f2328">,</span> <span style="color:#032f62">:at</span> <span style="color:#0550ae">=&gt;</span> <span style="color:#0a3069">&#39;4:30 am&#39;</span> <span style="color:#cf222e">do</span>
</span></span><span style="display:flex;"><span>  command <span style="color:#0a3069">&#34;/scripts/daily_backup.rb&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">end</span>
</span></span></code></pre></div><p>So that&rsquo;s cool, but now we have to create a separate file that houses our schedule definitions and manage it as well as the scripts we want to run. What would be really cool, I thought, would be to include the schedule definitions at the top of each script. The big win in this case is easily accessible &amp; portable schedule documentation.</p>
<p>One way of accomplishing this is to prepend all your Ruby scripts with a snippet similar to this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#57606a"># filename: /scripts/weekly_backup.rb</span>
</span></span><span style="display:flex;"><span>every <span style="color:#032f62">:sunday</span><span style="color:#1f2328">,</span> <span style="color:#032f62">:at</span> <span style="color:#0550ae">=&gt;</span> <span style="color:#0a3069">&#39;12pm&#39;</span> <span style="color:#cf222e">do</span>
</span></span><span style="display:flex;"><span>    command <span style="color:#0a3069">&#34;/scripts/weekly_backup.rb&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">end</span> <span style="color:#cf222e">if</span> defined?<span style="color:#1f2328">(</span><span style="color:#0550ae">Whenever</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">return</span> <span style="color:#cf222e">unless</span> <span style="color:#6a737d">__FILE__</span> <span style="color:#0550ae">==</span> <span style="color:#953800">$PROGRAM_NAME</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">puts</span> <span style="color:#0a3069">&#34;this is the start of my backup script&#34;</span>
</span></span></code></pre></div><p>When this script is executed using the <code>whenever</code> command (which you use to actually generate and install the cron jobs), the first <code>every</code> block will be used and everything after the <code>return</code> line will be ignored. When this script is executed directly, the <code>every</code> block will be ignored and everything after the <code>return</code> line will be executed.</p>
<p>Writing the crontab with this script will look like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#1f2328">whenever -w -f /scripts/weekly_backup.rb
</span></span></span></code></pre></div><p>Which will install a cron job that looks like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#1f2328">0 12 * * 0 /scripts/weekly_backup.rb
</span></span></span></code></pre></div><p>The major drawback to this method is we have to hard code the full path to the script instead of using the <code>__FILE__</code> variable, which hurts portability. This is because <code>Whenever</code> <code>evals</code> the content of the file read in and in this case <code>__FILE__</code> is useless. There is access to the calling file path via <code>Whenever::CommandLine.default_identifier</code> but this is currently a protected method.</p>
<p>This is just my first attempt at embedding scheduling information inside the script being scheduled, so there are probably easier/better ways of getting this done. Know any?</p>

  </div>

  <ul class="post-share-buttons">
    <li class="service_twitter post-share-1">
      <a class="icon-twitter" href="https://twitter.com/intent/tweet?url=http%3a%2f%2flocalhost%3a1313%2f2009%2f08%2fself-scheduling-ruby-scripts%2f&via=jerodsanto&text=Self-Scheduling%20Ruby%20Scripts" title="Tweet">
        <span>Tweet</span>
      </a>
    </li>
    <li class="service_rss post-share-2">
      <a class="icon-rss" href="/index.xml" title="Subscribe to the feed!">
        <span>RSS</span>
      </a>
    </li>
    <li class="service_hackernews post-share-3">
      <a class="icon-hackernews" href="http://news.ycombinator.com/submitlink?u=http%3a%2f%2flocalhost%3a1313%2f2009%2f08%2fself-scheduling-ruby-scripts%2f&t=Self-Scheduling%20Ruby%20Scripts" title="Post to Hacker News">
        <span>Hacker News</span>
      </a>
    </li>
    <li class="service_instapaper post-share-4">
      <a class="icon-instapaper" href="http://www.instapaper.com/hello2?url=http%3a%2f%2flocalhost%3a1313%2f2009%2f08%2fself-scheduling-ruby-scripts%2f&title=Self-Scheduling%20Ruby%20Scripts" title="Read later">
        <span>Instapaper</span>
      </a>
    </li>
  </ul>

  
  

  <div id="disqus_thread"></div>
  <script>
    var disqus_url   = "http:\/\/localhost:1313\/2009\/08\/self-scheduling-ruby-scripts\/";
    var disqus_title = "Self-Scheduling Ruby Scripts";
    (function() {
     var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
     dsq.src = 'https://blogt0sk1.disqus.com/embed.js';
     (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>

  <script src="//platform.twitter.com/widgets.js"></script>
</article>


    <footer class="main-footer">
  <p>
    Copyright &copy; 2008&mdash;2025 Jerod Santo
  </p>
</footer>

    
    <script src="/js/compiled.js"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-3287978-16', 'auto');
      ga('send', 'pageview');
    </script>
    
  </body>
</html>