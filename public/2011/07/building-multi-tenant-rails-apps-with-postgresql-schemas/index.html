<!DOCTYPE html>



 <html class="no-js"> 
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="author" content="Jerod Santo">
    <meta property="og:site_name" content="Jerod Santo">
    
    <meta name="description" content="Many Rails apps need to accommodate multiple tenants. There are a few different ways to go about this, each with their set of pros and cons. Guy Naor did a great job of diving into the pros and cons of each strategy in his 2009 Acts As Conference talk (a must-watch).
One of the multi-tenant strategies he presented takes advantage of a feature specific to PostgreSQL called &ldquo;Schemas&rdquo;. His talk was technical, but didn&rsquo;t go in-depth into implementation details. There are a few blog posts, Stack Overflow threads, and other semi-related flotsam around the tubes on how to actually accomplish a multi-tenant app using this strategy, but I still had to figure out many things on my own so I figured I&rsquo;d document the setup.">
    <meta property="st:title" content="Building Multi-tenant Rails Apps with PostgreSQL Schemas">
    <meta property="og:title" content="Building Multi-tenant Rails Apps with PostgreSQL Schemas">
    <meta property="og:description" content="Many Rails apps need to accommodate multiple tenants. There are a few different ways to go about this, each with their set of pros and cons. Guy Naor did a great job of diving into the pros and cons of each strategy in his 2009 Acts As Conference talk (a must-watch).
One of the multi-tenant strategies he presented takes advantage of a feature specific to PostgreSQL called &ldquo;Schemas&rdquo;. His talk was technical, but didn&rsquo;t go in-depth into implementation details. There are a few blog posts, Stack Overflow threads, and other semi-related flotsam around the tubes on how to actually accomplish a multi-tenant app using this strategy, but I still had to figure out many things on my own so I figured I&rsquo;d document the setup.">
    <meta property="og:type" content="article">
    
    <meta property="og:image" content="/icon.png">
    
    
    <title>
      Building Multi-tenant Rails Apps with PostgreSQL Schemas | Jerod Santo
    </title>

    <link rel="icon" href="/icon.png" sizes="256x256" type="image/png">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" type="text/css" media="all" href="/styles.css">
    <script>
       
      window.grunticon=function(e){if(e&&3===e.length){var t=window,n=!(!t.document.createElementNS||!t.document.createElementNS("http://www.w3.org/2000/svg","svg").createSVGRect||!document.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#Image","1.1")||window.opera&&-1===navigator.userAgent.indexOf("Chrome")),o=function(o){var r=t.document.createElement("link"),a=t.document.getElementsByTagName("script")[0];r.rel="stylesheet",r.href=e[o&&n?0:o?1:2],a.parentNode.insertBefore(r,a)},r=new t.Image;r.onerror=function(){o(!1)},r.onload=function(){o(1===r.width&&1===r.height)},r.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=="}};
      grunticon(["/icons/icons.data.svg.css", "/icons/icons.data.png.css", "/icons/icons.fallback.css"]);
    </script>

    <link href='//fonts.googleapis.com/css?family=Roboto+Condensed:400italic,400' rel='stylesheet' type='text/css'>
    <script src="//use.typekit.net/ozg5mvx.js"></script>
    <script>try{Typekit.load();}catch(e){}</script>
    <script src="/js/modernizr-custom.js"></script>

    

    <link rel="alternate" type="application/atom+xml" href="/index.xml" />
  </head>
  <body class="">
    
    <div class="main-header">
      <h1>
        <a href="/" title="Home">
          <span class="big-dot">&middot;</span> Jerod Santo <span class="big-dot">&middot;</span>
        </a>
      </h1>
      <a href="javascript:void(0);" title="Moar" class="main-header-more">+</a>
      <a href="/archives/" title="View Blog Archives" class="main-header-archive">Archives</a>
      <a href="mailto:jerod.santo@gmail.com" title="Contact Jerod" class="main-header-contact">Contact</a>
      <a href="/search/" title="Search the site" class="main-header-search">Search</a>
    </div>
    

    
<article class="post">
  <header class="post-header">
    <h1>Building Multi-tenant Rails Apps with PostgreSQL Schemas</h1>
    
    <p class="post-date">
      July 18, 2011
    </p>
  </header>

  

  <div class="post-content">
    <p>Many Rails apps need to accommodate multiple tenants. There are a few different ways to go about this, each with their set of pros and cons. Guy Naor did a great job of diving into the pros and cons of each strategy in his <a href="http://confreaks.net/videos/111-aac2009-writing-multi-tenant-applications-in-rails">2009 Acts As Conference talk</a> (a must-watch).</p>
<p>One of the multi-tenant strategies he presented takes advantage of a feature specific to <a href="http://www.postgresql.org">PostgreSQL</a> called &ldquo;Schemas&rdquo;. His talk was technical, but didn&rsquo;t go in-depth into implementation details. There are a few blog posts, <a href="http://stackoverflow.com/questions/2782758/creating-a-multi-tenant-application-using-postgresqls-schemas-and-rails">Stack Overflow</a> threads, and other semi-related flotsam around the tubes on how to actually accomplish a multi-tenant app using this strategy, but I still had to figure out many things on my own so I figured I&rsquo;d document the setup.</p>
<h2 id="why-postgresql-schemas">Why PostgreSQL Schemas</h2>
<p>Guy laid out three basic strategies for multi-tenant Rails apps.</p>
<ol>
<li>Separate databases for each tenant</li>
<li>One database with records scoped through a &ldquo;tenant&rdquo; relationship</li>
<li>One database with separate schemas for each tenant (PostgreSQL only)</li>
</ol>
<p>I won&rsquo;t lay out all the factors in choosing a multi-tenant strategy, but I&rsquo;ll tell you when you might want to choose strategy #3. If your app has the following characteristics:</p>
<ol>
<li>Each tenant&rsquo;s data is private and should not be leaked across tenants</li>
<li>You have little or no need to run queries that aggregate across all tenants</li>
<li>You may have many tenants and can&rsquo;t handle high administration overhead</li>
</ol>
<p>There are, of course, nuances to every application so, seriously, <a href="http://confreaks.net/videos/111-aac2009-writing-multi-tenant-applications-in-rails">go watch his talk</a> and make the decision on your own. If you decide you&rsquo;d like to go the PostgreSQL Schema route, come back and finish reading this post.</p>
<h2 id="how-postgresql-schemas-work">How PostgreSQL Schemas Work</h2>
<p>&ldquo;Schema&rdquo; is such a terrible name for this feature. When most people hear the term &ldquo;schema&rdquo; they think of a data definition of some sort. This is not what <a href="http://www.postgresql.org/docs/9.0/static/ddl-schemas.html">PostgreSQL schemas</a> are. I&rsquo;m sure the PostgreSQL devs had their reasons, but I really wish they would have named it more appropriately. &ldquo;Namespaces&rdquo; would have been apropos.</p>
<p>Anywho, the easiest way for me to describe PostgreSQL schemas (besides telling you that they are, indeed, namespaces for tables) is to relate them to the UNIX execution path. When you run a UNIX command without specifying its absolute path, your shell will work its way down the <code>$PATH</code> until it finds an executable of the same name.</p>
<p>Given that your <code>$PATH</code> looks like this:</p>
<p><code>/usr/local/bin:/usr/bin</code></p>
<p>When you type <code>vim</code> your shell will look for <code>vim</code> in <code>/usr/local/bin</code> and then in <code>/usr/bin</code> before giving up.</p>
<p>PostgreSQL schemas work pretty much the same way. Every table in a PostgreSQL database belongs to a schema. By default tables go in the <code>public</code> schema. You can see the current schema search path in psql by executing:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#cf222e">SHOW</span><span style="color:#fff"> </span>search_path<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span></code></pre></div><p>If you haven&rsquo;t done any schema-related stuff yet, you&rsquo;ll see <code>&quot;$user&quot;,public</code> as the search path. This means when you query a table without explicitly specifying the table&rsquo;s <strike>namespace</strike> schema it will first look in your user&rsquo;s schema (every user gets one) and then in the public schema before giving up. That means that:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#cf222e">SELECT</span><span style="color:#fff"> </span><span style="color:#cf222e">count</span><span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#cf222e">FROM</span><span style="color:#fff"> </span>users<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span></code></pre></div><p>Is functionally equivalent to:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#cf222e">SELECT</span><span style="color:#fff"> </span><span style="color:#cf222e">count</span><span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#cf222e">FROM</span><span style="color:#fff"> </span><span style="color:#cf222e">public</span><span style="color:#1f2328">.</span>users<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span></code></pre></div><p>What does all this mean? It means you can have the same table many times in one database as long as they each live in their own schema and you can query those tables without having to explicitly state which schema they&rsquo;re in. You just have to set the schema search path appropriately and PostgreSQL will handle the rest.</p>
<p>In other words, you get data separation across tenants by modifying very little of your application logic!</p>
<h2 id="setting-the-search-path">Setting the Search Path</h2>
<p>So how do you do all that in Rails?</p>
<div class="notice">NOTE: This implementation targets Rails 3.0.9 and PostgreSQL 9.0.4. YMMV</div>
<p>First, let&rsquo;s assume you have a <code>Tenant</code> model which holds a unique subdomain string. When an HTTP request comes in with a subdomain in it, you find the appropriate tenant and use its primary key (<code>id</code>) to set the search path (you could use the subdomain itself, but you may want to allow your users to change their subdomain).</p>
<p>This logic should happen on every request so put it in a <code>before_filter</code> in your <code>ApplicationController</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#cf222e">class</span> <span style="color:#1f2328">ApplicationController</span> <span style="color:#0550ae">&lt;</span> <span style="color:#0550ae">ActionController</span><span style="color:#0550ae">::</span><span style="color:#0550ae">Base</span>
</span></span><span style="display:flex;"><span>  before_filter <span style="color:#032f62">:handle_subdomain</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">def</span> <span style="color:#6639ba">handle_subdomain</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#953800">@tenant</span> <span style="color:#0550ae">=</span> <span style="color:#0550ae">Tenant</span><span style="color:#0550ae">.</span>find_by_subdomain<span style="color:#1f2328">(</span>request<span style="color:#0550ae">.</span>subdomain<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#0550ae">PgTools</span><span style="color:#0550ae">.</span>set_search_path <span style="color:#953800">@tenant</span><span style="color:#0550ae">.</span>id
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">else</span>
</span></span><span style="display:flex;"><span>      <span style="color:#0550ae">PgTools</span><span style="color:#0550ae">.</span>restore_default_search_path
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">end</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">end</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">end</span>
</span></span></code></pre></div><p>The logic isn&rsquo;t difficult to follow. You set the search path to the matched tenant if one is found. Otherwise you restore the default search path. The database bits are tucked away inside <code>PgTools</code>, which is a very small module you can drop into <code>lib/</code>. Here are the relevant methods:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#cf222e">module</span> <span style="color:#24292e">PgTools</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">extend</span> <span style="color:#6639ba">self</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">def</span> <span style="color:#6639ba">search_path</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0550ae">ActiveRecord</span><span style="color:#0550ae">::</span><span style="color:#0550ae">Base</span><span style="color:#0550ae">.</span>connection<span style="color:#0550ae">.</span>schema_search_path
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">def</span> <span style="color:#6639ba">default_search_path</span>
</span></span><span style="display:flex;"><span>    <span style="color:#953800">@default_search_path</span> <span style="color:#0550ae">||=</span> <span style="color:#0a3069">%{&#34;$user&#34;, public}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">def</span> <span style="color:#6639ba">set_search_path</span><span style="color:#1f2328">(</span><span style="color:#6639ba">name</span><span style="color:#1f2328">,</span> include_public <span style="color:#0550ae">=</span> <span style="color:#cf222e">true</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    path_parts <span style="color:#0550ae">=</span> <span style="color:#0550ae">[</span><span style="color:#6639ba">name</span><span style="color:#0550ae">.</span>to_s<span style="color:#1f2328">,</span> <span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;public&#34;</span> <span style="color:#cf222e">if</span> include_public<span style="color:#1f2328">)</span><span style="color:#0550ae">].</span>compact
</span></span><span style="display:flex;"><span>    <span style="color:#0550ae">ActiveRecord</span><span style="color:#0550ae">::</span><span style="color:#0550ae">Base</span><span style="color:#0550ae">.</span>connection<span style="color:#0550ae">.</span>schema_search_path <span style="color:#0550ae">=</span> path_parts<span style="color:#0550ae">.</span>join<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;,&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">def</span> <span style="color:#6639ba">restore_default_search_path</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0550ae">ActiveRecord</span><span style="color:#0550ae">::</span><span style="color:#0550ae">Base</span><span style="color:#0550ae">.</span>connection<span style="color:#0550ae">.</span>schema_search_path <span style="color:#0550ae">=</span> default_search_path
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">end</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">end</span>
</span></span></code></pre></div><p>These methods are pretty self-explanatory, but I will point out that the <code>set_search_path</code> method will include the public search path by default, but it can be disabled by passing <code>false</code> as a second parameter to the method. This will come into play a little further down.</p>
<p>In the case of a tenant with id of &ldquo;4&rdquo;, at the end of your <code>handle_subdomain</code> method the PostgreSQL schema search path will look like: <code>4, public</code></p>
<p>For the remainder of the request all of your queries will be sent through the &ldquo;4&rdquo; schema first as long as you have tables in it to be used. So how do you get all the tables in each tenant&rsquo;s schema?</p>
<h2 id="adding-new-tenants">Adding New Tenants</h2>
<p>The current database table definitions need to be loaded into the private schema of each new tenant of the system. You can perform this task in a callback after the tenant record has been created. Something like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#cf222e">class</span> <span style="color:#1f2328">Tenant</span> <span style="color:#0550ae">&lt;</span> <span style="color:#0550ae">ActiveRecord</span><span style="color:#0550ae">::</span><span style="color:#0550ae">Base</span>
</span></span><span style="display:flex;"><span>  after_create <span style="color:#032f62">:prepare_tenant</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">private</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">def</span> <span style="color:#6639ba">prepare_tenant</span>
</span></span><span style="display:flex;"><span>    create_schema
</span></span><span style="display:flex;"><span>    load_tables
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">def</span> <span style="color:#6639ba">create_schema</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0550ae">PgTools</span><span style="color:#0550ae">.</span>create_schema <span style="color:#6639ba">id</span> <span style="color:#cf222e">unless</span> <span style="color:#0550ae">PgTools</span><span style="color:#0550ae">.</span>schemas<span style="color:#0550ae">.</span>include? <span style="color:#6639ba">id</span><span style="color:#0550ae">.</span>to_s
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">def</span> <span style="color:#6639ba">load_tables</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#cf222e">if</span> <span style="color:#0550ae">Rails</span><span style="color:#0550ae">.</span>env<span style="color:#0550ae">.</span>test?
</span></span><span style="display:flex;"><span>    <span style="color:#0550ae">PgTools</span><span style="color:#0550ae">.</span>set_search_path <span style="color:#6639ba">id</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">load</span> <span style="color:#0a3069">&#34;</span><span style="color:#0a3069">#{</span><span style="color:#0550ae">Rails</span><span style="color:#0550ae">.</span>root<span style="color:#0a3069">}</span><span style="color:#0a3069">/db/schema.rb&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0550ae">PgTools</span><span style="color:#0550ae">.</span>restore_default_search_path
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">end</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">end</span>
</span></span></code></pre></div><p>After the <code>create_schema</code> method ensures that the new tenant has their own schema, the <code>load_tables</code> method sets the search path to its schema and loads the &ldquo;schema.rb&rdquo; file. You may notice that this time <code>false</code> is being sent to the <code>set_search_path</code> method. That is because you only want the loaded &ldquo;schema.rb&rdquo; file to affect the tenant&rsquo;s schema, NOT the public schema.</p>
<div class="notice">NOTE: This code may take awhile to execute and should be run in a background process.</div>
<p>Here you&rsquo;re using two more methods from the <code>PgTools</code> module. Here are their implementations:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">create_schema</span><span style="color:#1f2328">(</span><span style="color:#6639ba">name</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>  sql <span style="color:#0550ae">=</span> <span style="color:#0a3069">%{CREATE SCHEMA &#34;</span><span style="color:#0a3069">#{</span><span style="color:#6639ba">name</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0550ae">ActiveRecord</span><span style="color:#0550ae">::</span><span style="color:#0550ae">Base</span><span style="color:#0550ae">.</span>connection<span style="color:#0550ae">.</span>execute sql
</span></span><span style="display:flex;"><span><span style="color:#cf222e">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">schemas</span>
</span></span><span style="display:flex;"><span>  sql <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;SELECT nspname FROM pg_namespace WHERE nspname !~ &#39;^pg_.*&#39;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0550ae">ActiveRecord</span><span style="color:#0550ae">::</span><span style="color:#0550ae">Base</span><span style="color:#0550ae">.</span>connection<span style="color:#0550ae">.</span>query<span style="color:#1f2328">(</span>sql<span style="color:#1f2328">)</span><span style="color:#0550ae">.</span>flatten
</span></span><span style="display:flex;"><span><span style="color:#cf222e">end</span>
</span></span></code></pre></div><p>At this point you&rsquo;ve accomplished the bulk of the logic that goes into a multi-tenant Rails app with PostgreSQL schemas, but there are a few other things that you&rsquo;ll want to be aware of.</p>
<h2 id="migrating-tenants">Migrating Tenants</h2>
<p>Since every tenant has their own set of tables, it is no longer good enough to just run <code>rake db:migrate</code> to make database changes. Instead, each tenant must have its schema&rsquo;s tables migrated.</p>
<p>This isn&rsquo;t too bad, you just need a custom rake task which loops over the <code>tenants</code> table, setting the schema search path and migrating the database. Add this to <code>lib/tasks/tenants.rake</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>namespace <span style="color:#032f62">:tenants</span> <span style="color:#cf222e">do</span>
</span></span><span style="display:flex;"><span>  namespace <span style="color:#032f62">:db</span> <span style="color:#cf222e">do</span>
</span></span><span style="display:flex;"><span>    desc <span style="color:#0a3069">&#34;runs db:migrate on each tenant&#39;s private schema&#34;</span>
</span></span><span style="display:flex;"><span>    task <span style="color:#032f62">migrate</span><span style="color:#1f2328">:</span> <span style="color:#032f62">:environment</span> <span style="color:#cf222e">do</span>
</span></span><span style="display:flex;"><span>      verbose <span style="color:#0550ae">=</span> <span style="color:#0550ae">ENV</span><span style="color:#0550ae">[</span><span style="color:#0a3069">&#34;VERBOSE&#34;</span><span style="color:#0550ae">]</span> <span style="color:#1f2328">?</span> <span style="color:#0550ae">ENV</span><span style="color:#0550ae">[</span><span style="color:#0a3069">&#34;VERBOSE&#34;</span><span style="color:#0550ae">]</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;true&#34;</span> <span style="color:#1f2328">:</span> <span style="color:#cf222e">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#0550ae">ActiveRecord</span><span style="color:#0550ae">::</span><span style="color:#0550ae">Migration</span><span style="color:#0550ae">.</span>verbose <span style="color:#0550ae">=</span> verbose
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#0550ae">Tenant</span><span style="color:#0550ae">.</span>all<span style="color:#0550ae">.</span>each <span style="color:#cf222e">do</span> <span style="color:#0550ae">|</span>tenant<span style="color:#0550ae">|</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">puts</span> <span style="color:#0a3069">&#34;migrating tenant </span><span style="color:#0a3069">#{</span>tenant<span style="color:#0550ae">.</span>id<span style="color:#0a3069">}</span><span style="color:#0a3069"> (</span><span style="color:#0a3069">#{</span>tenant<span style="color:#0550ae">.</span>subdomain<span style="color:#0a3069">}</span><span style="color:#0a3069">)&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0550ae">PgTools</span><span style="color:#0550ae">.</span>set_search_path tenant<span style="color:#0550ae">.</span>id<span style="color:#1f2328">,</span> <span style="color:#cf222e">false</span>
</span></span><span style="display:flex;"><span>        version <span style="color:#0550ae">=</span> <span style="color:#0550ae">ENV</span><span style="color:#0550ae">[</span><span style="color:#0a3069">&#34;VERSION&#34;</span><span style="color:#0550ae">]</span> <span style="color:#1f2328">?</span> <span style="color:#0550ae">ENV</span><span style="color:#0550ae">[</span><span style="color:#0a3069">&#34;VERSION&#34;</span><span style="color:#0550ae">].</span>to_i <span style="color:#1f2328">:</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0550ae">ActiveRecord</span><span style="color:#0550ae">::</span><span style="color:#0550ae">Migrator</span><span style="color:#0550ae">.</span>migrate<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;db/migrate/&#34;</span><span style="color:#1f2328">,</span> version<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#cf222e">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">end</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">end</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">end</span>
</span></span></code></pre></div><p>Be sure to run this in addition to <code>rake db:migrate</code>. You may want to hook it in to the <code>db:migrate</code> task somehow. If you do, please add your solution to the comments as I have not done this yet.</p>
<p>This should also be hooked into your deploy process. If you&rsquo;re using capistrano to deploy, you can add it like so:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>namespace <span style="color:#032f62">:db</span> <span style="color:#cf222e">do</span>
</span></span><span style="display:flex;"><span>  desc <span style="color:#0a3069">&#34;Runs rake task which migrates database tables for all tenants&#34;</span>
</span></span><span style="display:flex;"><span>  task <span style="color:#032f62">:migrate_tenants</span> <span style="color:#cf222e">do</span>
</span></span><span style="display:flex;"><span>    env <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;RAILS_ENV=production&#34;</span>
</span></span><span style="display:flex;"><span>    run <span style="color:#0a3069">&#34;cd </span><span style="color:#0a3069">#{</span>release_path<span style="color:#0a3069">}</span><span style="color:#0a3069"> &amp;&amp; bundle exec rake </span><span style="color:#0a3069">#{</span>env<span style="color:#0a3069">}</span><span style="color:#0a3069"> tenants:db:migrate&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">end</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>after <span style="color:#0a3069">&#34;deploy:migrate&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;db:migrate_tenants&#34;</span>
</span></span></code></pre></div><p>That should do it!</p>
<h2 id="shared-tables">Shared Tables</h2>
<p>So far this post has just compiled and distilled information available from various sources, but one thing that nobody else seems to be talking about is that not <em>all</em> of your application&rsquo;s tables will be private to each tenant.</p>
<p>The <code>tenants</code> table itself, for example, needs to be accessible to all tenants (how else will they edit their account settings?). Also, what if you want users to be able to log in to multiple tenants across the system (single sign-on)?</p>
<p>One way to accomplish this is to have shared tables live in the public schema and private tables live in the tenant-specific schemas. Technically, all tables must exist in the public schema for Rails to boot properly. This is not a problem. Since the search path is being set to look in the private schemas first it will find the tables there and use the right table. However, if a private schema has a <code>tenants</code> table and the public schema has the <code>tenants</code> table with data in it, the wrong one will be used.</p>
<p>One solution is to delete the shared tables from the private schemas. This will ensure that the search path won&rsquo;t find them in the private schemas and will find them in the public schema.</p>
<p>To accomplish this, I maintain a list of shared tables (this is kind of hacky, but the list is short) and modify the <code>Tenant#load_tables</code> method to look like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">load_tables</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">return</span> <span style="color:#cf222e">if</span> <span style="color:#0550ae">Rails</span><span style="color:#0550ae">.</span>env<span style="color:#0550ae">.</span>test?
</span></span><span style="display:flex;"><span>  <span style="color:#0550ae">PgTools</span><span style="color:#0550ae">.</span>set_search_path <span style="color:#6639ba">id</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6639ba">load</span> <span style="color:#0a3069">&#34;</span><span style="color:#0a3069">#{</span><span style="color:#0550ae">Rails</span><span style="color:#0550ae">.</span>root<span style="color:#0a3069">}</span><span style="color:#0a3069">/db/schema.rb&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0550ae">MyApp</span><span style="color:#0550ae">::</span><span style="color:#0550ae">SHARED_TABLES</span><span style="color:#0550ae">.</span>each <span style="color:#1f2328">{</span> <span style="color:#0550ae">|</span><span style="color:#6639ba">name</span><span style="color:#0550ae">|</span> connection<span style="color:#0550ae">.</span>execute <span style="color:#0a3069">%{drop table &#34;</span><span style="color:#0a3069">#{</span><span style="color:#6639ba">name</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;}</span> <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0550ae">PgTools</span><span style="color:#0550ae">.</span>restore_default_search_path
</span></span><span style="display:flex;"><span><span style="color:#cf222e">end</span>
</span></span></code></pre></div><p>Imagine an application that has a shared <code>users</code> table and private <code>posts</code> and <code>comments</code> tables. With this setup the table list will looks like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#1f2328">public.posts
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">public.comments
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">public.users
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">1.posts
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">1.comments
</span></span></span></code></pre></div><p>When the search path is set to <code>1, public</code> the comments and posts will be fetched from the &ldquo;1&rdquo; schema and the users will be fetched from the public schema. That&rsquo;s pretty cool, if you ask me!</p>
<p>This does throw a wrench in one more area of development: migrating shared tables. The private schemas will not have the shared tables in them, so you will encounter errors when looping through them and running migrations. The fix to this is simple enough, but needs to be communicated to all developers on the project.</p>
<p>Any migration that operates on shared tables should be short-circuited if the current schema search path is private. Add this method to <code>PgTools</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">private_search_path?</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0550ae">!</span>search_path<span style="color:#0550ae">.</span>match <span style="color:#0a3069">/public/</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">end</span>
</span></span></code></pre></div><p>Consider adding a boolean admin to the aforementioned shared <code>users</code> table. The migration should looks like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#cf222e">class</span> <span style="color:#1f2328">AddAdminToUsers</span> <span style="color:#0550ae">&lt;</span> <span style="color:#0550ae">ActiveRecord</span><span style="color:#0550ae">::</span><span style="color:#0550ae">Migration</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">def</span> <span style="color:#1f2328">self</span><span style="color:#0550ae">.</span><span style="color:#6639ba">up</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#cf222e">if</span> <span style="color:#0550ae">PgTools</span><span style="color:#0550ae">.</span>private_search_path?
</span></span><span style="display:flex;"><span>    add_column <span style="color:#032f62">:users</span><span style="color:#1f2328">,</span> <span style="color:#032f62">:admin</span><span style="color:#1f2328">,</span> <span style="color:#032f62">:boolean</span><span style="color:#1f2328">,</span> <span style="color:#032f62">default</span><span style="color:#1f2328">:</span> <span style="color:#cf222e">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">def</span> <span style="color:#1f2328">self</span><span style="color:#0550ae">.</span><span style="color:#6639ba">down</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#cf222e">if</span> <span style="color:#0550ae">PgTools</span><span style="color:#0550ae">.</span>private_search_path?
</span></span><span style="display:flex;"><span>    remove_column <span style="color:#032f62">:users</span><span style="color:#1f2328">,</span> <span style="color:#032f62">:admin</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">end</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">end</span>
</span></span></code></pre></div><p>This migration will run as normal during <code>rake db:migrate</code> and get safely skipped during <code>rake tenants:db:migrate</code>.</p>
<h2 id="good-luck">Good luck!</h2>
<p>I hope this post serves as a guide for your own adventure into multi-tenant Rails apps on PostgreSQL. I&rsquo;ve been using it for some time now and while there is a lot to wrap your head around and set up at the outset, it pays off in spades when you can ignore the entire problem for much of your application logic and have the peace of mind that a coding mistake won&rsquo;t accidentally expose your customers&rsquo; sensitive data.</p>
<p>Let me know how you get on!</p>

  </div>

  <ul class="post-share-buttons">
    <li class="service_twitter post-share-1">
      <a class="icon-twitter" href="https://twitter.com/intent/tweet?url=http%3a%2f%2flocalhost%3a1313%2f2011%2f07%2fbuilding-multi-tenant-rails-apps-with-postgresql-schemas%2f&via=jerodsanto&text=Building%20Multi-tenant%20Rails%20Apps%20with%20PostgreSQL%20Schemas" title="Tweet">
        <span>Tweet</span>
      </a>
    </li>
    <li class="service_rss post-share-2">
      <a class="icon-rss" href="/index.xml" title="Subscribe to the feed!">
        <span>RSS</span>
      </a>
    </li>
    <li class="service_hackernews post-share-3">
      <a class="icon-hackernews" href="http://news.ycombinator.com/submitlink?u=http%3a%2f%2flocalhost%3a1313%2f2011%2f07%2fbuilding-multi-tenant-rails-apps-with-postgresql-schemas%2f&t=Building%20Multi-tenant%20Rails%20Apps%20with%20PostgreSQL%20Schemas" title="Post to Hacker News">
        <span>Hacker News</span>
      </a>
    </li>
    <li class="service_instapaper post-share-4">
      <a class="icon-instapaper" href="http://www.instapaper.com/hello2?url=http%3a%2f%2flocalhost%3a1313%2f2011%2f07%2fbuilding-multi-tenant-rails-apps-with-postgresql-schemas%2f&title=Building%20Multi-tenant%20Rails%20Apps%20with%20PostgreSQL%20Schemas" title="Read later">
        <span>Instapaper</span>
      </a>
    </li>
  </ul>

  
  

  <div id="disqus_thread"></div>
  <script>
    var disqus_url   = "http:\/\/localhost:1313\/2011\/07\/building-multi-tenant-rails-apps-with-postgresql-schemas\/";
    var disqus_title = "Building Multi-tenant Rails Apps with PostgreSQL Schemas";
    (function() {
     var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
     dsq.src = 'https://blogt0sk1.disqus.com/embed.js';
     (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>

  <script src="//platform.twitter.com/widgets.js"></script>
</article>


    <footer class="main-footer">
  <p>
    Copyright &copy; 2008&mdash;2025 Jerod Santo
  </p>
</footer>

    
    <script src="/js/compiled.js"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-3287978-16', 'auto');
      ga('send', 'pageview');
    </script>
    
  </body>
</html>